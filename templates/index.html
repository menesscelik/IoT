<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>LLM Asistan</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #log { margin-top: 20px; border-top: 1px solid #ccc; padding-top: 10px; }
        .entry { margin-bottom: 15px; }
        .user { color: blue; }
        .reply { color: green; }
    </style>
</head>
<body>
    <h1>LLM Sesli Asistan</h1>
    <button id="recordButton">ğŸ™ï¸ KaydÄ± BaÅŸlat</button>
    <p id="status">HazÄ±r</p>

    <div id="log"></div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        const recordButton = document.getElementById("recordButton");
        const status = document.getElementById("status");
        const log = document.getElementById("log");

        recordButton.onclick = async () => {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                status.innerText = "Kaydediliyor...";
                recordButton.innerText = "ğŸ™ï¸ KaydÄ± BaÅŸlat";
                return;
            }

            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const arrayBuffer = await audioBlob.arrayBuffer();
                const sessionId = crypto.randomUUID();
                const headers = {
                    'X-First-Chunk': 'true',
                    'X-Last-Chunk': 'true',
                    'X-Session-ID': sessionId,
                    'Content-Type': 'application/octet-stream'
                };

                status.innerText = "Sunucuya gÃ¶nderiliyor...";
                const response = await fetch('/upload', {
                    method: 'POST',
                    headers,
                    body: arrayBuffer
                });

                const json = await response.json();
                const userText = json.user_text || "(algÄ±lanamadÄ±)";
                const assistantText = json.reply || "(yanÄ±t yok)";

                const entry = document.createElement("div");
                entry.classList.add("entry");
                entry.innerHTML = `<div class="user"><strong>Siz:</strong> ${userText}</div>
                                    <div class="reply"><strong>Asistan:</strong> ${assistantText}</div>`;
                log.prepend(entry);

                status.innerText = "HazÄ±r";
            };

            mediaRecorder.start();
            status.innerText = "KayÄ±t yapÄ±lÄ±yor...";
            recordButton.innerText = "â¹ï¸ KaydÄ± Durdur";
        };
    </script>
</body>
</html>